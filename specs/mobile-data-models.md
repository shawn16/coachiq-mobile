# Mobile Data Models

## Job to be Done

**When** the mobile app ecosystem needs to support coach-initiated requests, push notifications, and automated alerts,
**the system needs** new database models to track these workflows,
**so that** wellness/RPE requests, device tokens, and wellness alerts have persistent storage.

## Problem Statement

The current schema has no models for: coach-initiated requests to athletes, push notification device tokens, or wellness alert records. These four new models are required before any mobile API endpoints can be built.

---

## Specification

### Model 1: WellnessRequest

Tracks a coach's request for athletes to submit wellness check-ins.

| Field     | Type     | Constraints              | Description                         |
| --------- | -------- | ------------------------ | ----------------------------------- |
| id        | String   | PK, UUID, auto-generated | Unique identifier                   |
| teamId    | String   | FK to Team, required     | Which team                          |
| groupId   | String?  | FK to Group, optional    | Specific group (null = entire team) |
| coachId   | String   | FK to Coach, required    | Who requested it                    |
| message   | String?  | Max 200 chars            | Optional message to athletes        |
| deadline  | DateTime | Required, must be future | When responses are due              |
| createdAt | DateTime | Auto-generated           | When request was created            |

**Relations:**

- belongsTo Team
- belongsTo Group (optional)
- belongsTo Coach
- hasMany WellnessCheck (via wellnessRequestId)

### Model 2: RPERequest

Tracks a coach's request for athletes to submit RPE ratings for a specific workout.

| Field     | Type     | Constraints              | Description                         |
| --------- | -------- | ------------------------ | ----------------------------------- |
| id        | String   | PK, UUID, auto-generated | Unique identifier                   |
| teamId    | String   | FK to Team, required     | Which team                          |
| groupId   | String?  | FK to Group, optional    | Specific group (null = entire team) |
| workoutId | String   | FK to Workout, required  | Which workout needs RPE             |
| coachId   | String   | FK to Coach, required    | Who requested it                    |
| message   | String?  | Max 200 chars            | Optional message to athletes        |
| deadline  | DateTime | Required, must be future | When responses are due              |
| createdAt | DateTime | Auto-generated           | When request was created            |

**Relations:**

- belongsTo Team
- belongsTo Group (optional)
- belongsTo Workout
- belongsTo Coach

### Model 3: DeviceToken

Stores Expo push notification tokens for each athlete/coach device.

| Field     | Type     | Constraints              | Description                              |
| --------- | -------- | ------------------------ | ---------------------------------------- |
| id        | String   | PK, UUID, auto-generated | Unique identifier                        |
| userId    | String   | Required                 | Athlete ID or Coach ID                   |
| userRole  | String   | "athlete" or "coach"     | Distinguishes user type                  |
| token     | String   | Required, unique         | Expo push token (ExponentPushToken[xxx]) |
| isActive  | Boolean  | Default true             | Whether token is still valid             |
| createdAt | DateTime | Auto-generated           | When registered                          |
| updatedAt | DateTime | Auto-updated             | Last update                              |

**Constraints:**

- Unique compound index on (userId, token) — one record per device per user
- When Expo returns DeviceNotRegistered error, set isActive = false

### Model 4: WellnessAlert

Records alerts generated by the alert engine when wellness data triggers concern rules.

| Field           | Type     | Constraints                         | Description                                         |
| --------------- | -------- | ----------------------------------- | --------------------------------------------------- |
| id              | String   | PK, UUID, auto-generated            | Unique identifier                                   |
| wellnessCheckId | String   | FK to WellnessCheck, required       | Which submission triggered this                     |
| athleteId       | String   | FK to Athlete, required             | Which athlete                                       |
| teamId          | String   | FK to Team, required                | Which team (for coach queries)                      |
| ruleId          | String   | Required                            | Which alert rule fired (e.g., "hydration_critical") |
| severity        | String   | "critical", "high", "medium", "low" | Alert severity level                                |
| message         | String   | Required                            | Human-readable alert message                        |
| details         | Json     | Required                            | Rule-specific data (thresholds, actual values)      |
| isResolved      | Boolean  | Default false                       | Whether coach has acknowledged                      |
| createdAt       | DateTime | Auto-generated                      | When alert was created                              |

**Relations:**

- belongsTo WellnessCheck
- belongsTo Athlete
- belongsTo Team

---

## User Stories

### US-001: Create WellnessRequest Model

**As a** developer setting up the mobile schema,
**I want** the WellnessRequest model in the Prisma schema,
**so that** coaches can create requests for athlete wellness submissions.

**Acceptance Criteria:**

- [ ] WellnessRequest model exists in schema.prisma
- [ ] All fields match specification above
- [ ] FK relations to Team, Group, Coach are defined
- [ ] Relation to WellnessCheck (via wellnessRequestId) is defined
- [ ] Prisma validate passes
- [ ] Prisma migrate dev runs without error

### US-002: Create RPERequest Model

**As a** developer setting up the mobile schema,
**I want** the RPERequest model in the Prisma schema,
**so that** coaches can create requests for athlete RPE submissions.

**Acceptance Criteria:**

- [ ] RPERequest model exists in schema.prisma
- [ ] All fields match specification above
- [ ] FK relations to Team, Group, Workout, Coach are defined
- [ ] Prisma validate passes
- [ ] Prisma migrate dev runs without error

### US-003: Create DeviceToken Model

**As a** developer setting up push notification storage,
**I want** the DeviceToken model in the Prisma schema,
**so that** the system can store and query Expo push tokens for notification delivery.

**Acceptance Criteria:**

- [ ] DeviceToken model exists in schema.prisma
- [ ] All fields match specification above
- [ ] Unique compound index on (userId, token) exists
- [ ] Prisma validate passes
- [ ] Prisma migrate dev runs without error

### US-004: Create WellnessAlert Model

**As a** developer setting up the alert storage,
**I want** the WellnessAlert model in the Prisma schema,
**so that** the alert engine can persist alerts for coach review.

**Acceptance Criteria:**

- [ ] WellnessAlert model exists in schema.prisma
- [ ] All fields match specification above
- [ ] FK relations to WellnessCheck, Athlete, Team are defined
- [ ] details field is Json type
- [ ] Prisma validate passes
- [ ] Prisma migrate dev runs without error

---

## Out of Scope

- API endpoints that read/write these models (separate specs in later phases)
- Alert engine logic (separate spec)
- Push notification delivery logic (separate spec)
- Modifications to existing models (see wellness-check-expansion.md)

## Technical Notes

- All four models should be added in a single migration if possible
- The WellnessRequest model is referenced by the WellnessCheck.wellnessRequestId FK from the wellness-check-expansion spec — coordinate migration order
- DeviceToken.userId is a plain string (not a FK) because it can reference either an Athlete or a Coach
- WellnessAlert.details Json field stores variable data per rule type (e.g., `{"hydration": 2, "threshold": 3}`)
